function findDeviceIndexExtAddr(e){for(var t=0;t<devList.length;t++)if(devList[t].ext_addr===e)return t;return-1}function findDeviceIndexShortAddr(e){for(var t=0;t<devList.length;t++)if(devList[t].short_addr===e)return t;return-1}var app=angular.module("myApp",["ngTable","ngRoute","ngResource"]),devList=[];app.controller("deviceController",["NgTableParams","$scope","$http","$timeout",function(e,t,a,s){this.cols=[{field:"sensor",title:"Sensor",sortable:"sensor",show:!0},{field:"data",title:"Value",sortable:"data",show:!0},{field:"rssi",title:"RSSI",sortable:"rssi",show:!0}];var o,n;t.tableParams={};var r=function(){a({method:"GET",url:"/devices"}).then(function(a){var s,n=[],r=[],d=0;if(console.log("[DEV Get] Success: "+a.status+a.statusText+" Data: "+JSON.stringify(a.data)),console.log("[DEV Get] Dev List: ["+devList.length+"]"+JSON.stringify(devList,null,2)),devList.length>0){var l=findDeviceIndexExtAddr(a.data.d.ext_addr);if(console.log("[DEV Get] Index: "+l),l>=0){if(devList[l].rssi=a.data.d.rssi,devList[l].active=!0,a.data.d.smart_objects.hasOwnProperty("temperature"))for(s=0,console.log("[DEV Get] Index: ["+l+"] is Temperature");a.data.d.smart_objects.temperature.hasOwnProperty(s);)devList[l].sensors[d]={type:"temperature",value:a.data.d.smart_objects.temperature[s].sensorValue},d++,s++;if(a.data.d.smart_objects.hasOwnProperty("illuminance"))for(s=0,console.log("[DEV Get] Index: ["+l+"] is Light");a.data.d.smart_objects.illuminance.hasOwnProperty(s);)devList[l].sensors[d]={type:"illuminance",value:a.data.d.smart_objects.illuminance[s].sensorValue},d++,s++;if(a.data.d.smart_objects.hasOwnProperty("humidity"))for(s=0,console.log("[DEV Get] Index: ["+l+"] is Humidity");a.data.d.smart_objects.humidity.hasOwnProperty(s);)devList[l].sensors[d]={type:"humidity",value:a.data.d.smart_objects.humidity[s].sensorValue},d++,s++;if(a.data.d.smart_objects.hasOwnProperty("fan"))for(s=0,console.log("[DEV Get] Index: ["+l+"] is a Fan");a.data.d.smart_objects.fan.hasOwnProperty(s);)devList[l].sensors[d]={type:"fan",value:a.data.d.smart_objects.fan[s].sensorValue},d++,s++;if(a.data.d.smart_objects.hasOwnProperty("doorlock"))for(s=0,console.log("[DEV Get] Index: ["+l+"] is a Lock");a.data.d.smart_objects.doorlock.hasOwnProperty(s);)devList[l].sensors[d]={type:"doorlock",value:a.data.d.smart_objects.doorlock[s].sensorValue},d++,s++;if(a.data.d.smart_objects.hasOwnProperty("generic"))for(s=0,console.log("[DEV Get] Index: ["+l+"] is Generic");a.data.d.smart_objects.generic.hasOwnProperty(s);)devList[l].sensors[d]={type:"generic",value:a.data.d.smart_objects.generic[s].sensorValue},d++,s++}for(console.log("[DEV Get] Dev List: "+JSON.stringify(devList,null,2)),i=0;i<devList.length;i++)for(j=0;j<devList[i].sensors.length;j++){var c={sensor:devList[i].sensors[j].type,data:devList[i].sensors[j].value,shortaddr:devList[i].short_addr,rssi:devList[i].rssi};n.push(c)}for(console.log("[DEV Get] Temp List: "+JSON.stringify(n,null,2)),i=0;i<n.length;i++)o=n[i].data,"temperature"==n[i].sensor?n[i].data=o+" F":"humidity"==n[i].sensor?n[i].data=o+" %":"illuminance"==n[i].sensor?n[i].data=o+" lumens":"doorlock"==n[i].sensor?"1"==o?n[i].data="Locked":"0"==o&&(n[i].data="Unlocked"):"fan"==n[i].sensor&&(n[i].data="Speed: "+o);r=n,console.log("[DEV Get] simple List: "+JSON.stringify(r,null,2)),t.tableParams=new e({group:{shortaddr:"desc"}},{counts:[],dataset:r,groupOptions:{isExpanded:!0}}),t.tableParams.reload()}},function(e){console.log("[DEV Get] Failed: "+e.status+" "+e.statusText+" Data: "+JSON.stringify(e.data))}),s(r,5e3)};t.toggle=function(e){"doorlock"==e.sensor?"Unlocked"==e.data?n=1:"Locked"==e.data&&(n=0):n="fan"==e.sensor?e.speed:1,console.log("[Action Button POST] Posting: {dstAddr : "+e.shortaddr+", value: "+n+"}"),a({method:"POST",url:"/action",data:'action={"dstAddr":"'+e.shortaddr+'","value":"'+n+'"}',headers:{"Content-Type":"application/x-www-form-urlencoded"}})},s(r,5e3)}]),app.controller("nwkController",["NgTableParams","$scope","$http","$timeout",function(e,t,a,s){t.tableParams={};var o=[],n=function(){a({method:"GET",url:"/nwk"}).then(function(a){console.log("[NWK Get] Success: "+a.status+a.statusText+"  Data: "+JSON.stringify(a.data)),o[0]={key:"name",value:a.data.d.name},o[1]={key:"Short Address",value:a.data.d.short_addr},o[2]={key:"Extendded Address",value:a.data.d.ext_addr},o[3]={key:"Channels",value:a.data.d.channels},o[4]={key:"Mode",value:a.data.d.mode},o[5]={key:"State",value:a.data.d.state},console.log("[NWK Get] SimpleList: "+JSON.stringify(o,null,2)),console.log("[NWK Get] Dev List Length: "+a.data.d.devices.length);var s;for(i=0;i<a.data.d.devices.length;i++){var n=findDeviceIndexShortAddr(a.data.d.devices[i].short_addr);console.log("[NWK Get] Index: "+n),n<0&&(s={short_addr:a.data.d.devices[i].short_addr,ext_addr:a.data.d.devices[i].ext_addr,rssi:0,active:!0,sensors:[]},devList.push(s))}console.log("[NWK Get] Dev List: "+JSON.stringify(devList,null,2)),t.tableParams=new e({},{counts:[],dataset:o}),t.tableParams.reload()},function(e){console.log("[NWK Get] Failed: "+e.status+e.statusText+"  Data: "+JSON.stringify(e.data))}),s(n,5e3)};s(n,5e3)}]),app.controller("open",["$scope","$http","$timeout",function(e,t,a){e.value="open",e.open=function(){e.value="opening...",t({method:"POST",url:"/cmd",data:"cmd=true",headers:{"Content-Type":"application/x-www-form-urlencoded"}})}}]),app.controller("close",["$scope","$http","$timeout",function(e,t,a){e.value="close",e.close=function(){e.value="closing...",t({method:"POST",url:"/cmd",data:"cmd=false",headers:{"Content-Type":"application/x-www-form-urlencoded"}})}}]),app.controller("myCloudBtn",["$scope","$http","$timeout",function(e,t,a){e.save=function(){t({method:"POST",url:"/cloud",data:"org="+e.orgId+"&type="+e.deviceType+"&id="+e.deviceId+"&password="+e.password,headers:{"Content-Type":"application/x-www-form-urlencoded"}})}}]),app.controller("myDevStatusCtrl",["$scope","$http","$timeout",function(e,t,a){e.ipAddress="000.000.000.000",e.wifiConnection=!1,e.mqttConnection=!1,e.wifiConnection?(angular.element("#wifiCircle").removeClass("lightOff"),angular.element("#wifiCircle").addClass("lightOn")):(angular.element("#wifiCircle").removeClass("lightOn"),angular.element("#wifiCircle").addClass("lightOff")),e.mqttConnection?(angular.element("#mqttCircle").removeClass("lightOff"),angular.element("#mqttCircle").addClass("lightOn")):(angular.element("#mqttCircle").removeClass("lightOn"),angular.element("#mqttCircle").addClass("lightOff"));var s=function(){t({method:"GET",url:"/cloud"}).then(function(t){console.log("[Dev Status Get] Success: "+t.status+t.statusText+"  Data: "+JSON.stringify(t.data)),e.ipAddress=t.data.ipAddress,t.data.wifiConnection?(angular.element("#wifiCircle").removeClass("lightOff"),angular.element("#wifiCircle").addClass("lightOn")):(angular.element("#wifiCircle").removeClass("lightOn"),angular.element("#wifiCircle").addClass("lightOff")),t.data.mqttConnection?(angular.element("#mqttCircle").removeClass("lightOff"),angular.element("#mqttCircle").addClass("lightOn")):(angular.element("#mqttCircle").removeClass("lightOn"),angular.element("#mqttCircle").addClass("lightOff"))},function(e){console.log("[Dev Status Get]  Failed: "+e.status+e.statusText+"  Data: "+JSON.stringify(e.data))}),a(s,2e3)};a(s,2e3)}]);